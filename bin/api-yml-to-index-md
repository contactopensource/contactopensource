#!/usr/bin/env python3
import pprint
import re
import sys
import yaml

s=""
s.__contains__
class Entity:
    def __init__(self, id, summary, attributes, uml = None):
        self.id = id
        self.summary = summary
        self.attributes = attributes
        self.uml = uml

    def as_markdown(self):
        s = f"# {self.id}\n\n"
        s += f"{self.summary} \n\n"
        s += f"Attributes:\n\n"
        for attribute in self.attributes:
            s += attribute.as_markdown()
        return s
    
    def as_rails_generator(self):
        s = "rails generate scaffold \\\n"
        s += f"{self.id} \\\n"
        s += "$RAILS_GENERATE_SCAFFOLD_FIELDS_BEFORE \\\n"
        for attribute in self.attributes:
            s += attribute.as_rails_generator()
        s += "$RAILS_GENERATE_SCAFFOLD_FIELDS_AFTER\n"
        return s

    def as_plantuml(self):
        s = f"entity {self.id} " + "{\n"
        for attribute in self.attributes:
            s += attribute.as_plantuml()
        s += "}\n"
        if self.uml:
            s += f"\n{self.uml}\n"
        return s

class Attribute:
    def __init__(self, id, type, index, example, uml = None):
        self.id = id
        self.type = type
        self.index = index
        self.example = example
        self.uml = uml

    def use_join(self):
        return self.type.__contains__("(id)")

    def use_index(self):
        return self.index or self.use_join()

    def as_plus_index(self):
        return "+" if self.use_index() else ""

    def as_markdown(self):
        return f"* {self.id}: {self.type}{self.as_plus_index()} -- example: {self.example}\n\n"

    def as_plantuml(self):
        s = f"  {self.id} : {self.type}{self.as_plus_index()}\n"
        if self.uml:
            s += f"\n{self.uml}\n"
        return s

    def as_rails_generator(self):
        return f"{self.id}:{self.as_rails_generator_type()}{self.as_rails_generator_index()} \\\n"

    def as_rails_generator_type(self):
        if self.use_join():
            return "references"
        # Search for a type with a constraint e.g. "string(1)"
        x = re.search("(string)\((\d+)\)", self.type)
        if x:
            # Return a quoted type and curly constraint e.g. "\"string{1}\""
            return "\"{}{{{}}}\"".format(x.group(1), x.group(2))
        return self.type

    def as_rails_generator_index(self):
        return ":index" if self.use_index() else ""
        
def parse_attribute(id, y):
    return Attribute(id, y['type'], y.get('index', False), y['example'], y.get('uml', None))

def parse_attribute_kv(kv):
    return parse_attribute(*kv)

def parse_attributes(y):
    return list(map(parse_attribute_kv, y.items()))
    
def parse_entity(id, y):
    return Entity(id, y['summary'], parse_attributes(y['attributes']), y.get('uml', None))

def parse_entity_kv(kv):
    return parse_entity(*kv)

def parse_entities(y):
    return list(map(parse_entity_kv, y.items()))

def print_markdown(entities):
    for entity in entities:
        print(entity.as_markdown())

def print_rails_generator(entities):
    print("#!/bin/sh")
    print("set -euf")
    print()
    for entity in entities:
        print(entity.as_rails_generator())

def print_plantuml(entities):
    print("@startuml uml")
    print("skinparam monochrome true")
    print("skinparam linetype ortho")
    print("hide circle")
    print()
    for entity in entities:
        print(entity.as_plantuml())
    print("@enduml")

y = yaml.safe_load(sys.stdin.read())
#print(yaml.dump(y, indent=2, default_flow_style=False, sort_keys=False))
entities = parse_entities(y)

print_markdown(entities)
print_rails_generator(entities)
print_plantuml(entities)
